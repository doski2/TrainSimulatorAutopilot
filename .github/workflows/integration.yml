name: Integration Tests (Prometheus)

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: "pip-${{ hashFiles('**/requirements.txt') }}"
        restore-keys: |
          pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

    - name: Prepare Prometheus CI config
      run: |
        python - <<'PY'
        import io,sys
        p='prometheus/prometheus.yml'
        s=open(p).read()
        # Use localhost for the runner environment
        s=s.replace('localhost:5001','localhost:5001')
        open('prometheus/ci_prometheus.yml','w').write(s)
        print('WROTE prometheus/ci_prometheus.yml')
        PY

    - name: Start Prometheus container (pinned image)
      run: |
        docker run -d --name prometheus-ci -p 9090:9090 -v ${{ github.workspace }}/prometheus:/etc/prometheus prom/prometheus:2.44.0 --config.file=/etc/prometheus/ci_prometheus.yml

    - name: Wait for Prometheus ready
      run: |
        for i in {1..30}; do curl --silent --fail http://localhost:9090/-/ready && exit 0 || sleep 1; done; exit 1

    - name: Start web dashboard (capture logs)
      run: |
        nohup python web_dashboard.py > web_dashboard.log 2>&1 &
        sleep 2

    - name: Wait for dashboard /metrics
      run: |
        for i in {1..30}; do curl --silent --fail http://127.0.0.1:5001/metrics && exit 0 || sleep 1; done; exit 1

    - name: Ensure requests installed for checks
      run: python -m pip install requests

    - name: Check Prometheus sees the target
      run: |
        for i in {1..30}; do
          python -c "import sys,requests; r=requests.get('http://localhost:9090/api/v1/targets', timeout=5).json(); ok=False; \
for t in r.get('data',{}).get('activeTargets',[]): addr=t.get('discoveredLabels',{}).get('__address__'); \
if addr in ('127.0.0.1:5001','localhost:5001') and t.get('health')=='up': ok=True; break; sys.exit(0 if ok else 1)"
          if [ $? -eq 0 ]; then exit 0; fi
          sleep 1
        done
        echo "Prometheus did not see healthy target" && exit 1

    - name: Run integration tests
      run: |
        python -m pytest tests/integration -q

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: integration-logs
        path: |
          web_dashboard.log
          prometheus.log

    - name: Gather Prometheus logs (always)
      if: always()
      run: |
        docker logs prometheus-ci > prometheus.log || true

    - name: Stop Prometheus container
      if: always()
      run: docker rm -f prometheus-ci || true
