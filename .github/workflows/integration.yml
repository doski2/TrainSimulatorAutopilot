name: Integration Tests (Prometheus)

on:
  push:
    branches: [ master, main, develop ]
  workflow_dispatch: {}
  # Note: Removed `pull_request` trigger to avoid running heavy integration tests
  # on every PR. Use workflow_dispatch or push to main/master/develop for E2E runs.

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip
      uses: actions/cache@v5
      with:
        path: ~/.cache/pip
        key: "pip-${{ hashFiles('**/requirements.txt') }}"
        restore-keys: |
          pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

    - name: Prepare Prometheus CI config
      run: |
        python .github/scripts/generate_ci_prometheus.py


    - name: Start Prometheus container (pinned image)
      run: |
        docker run -d --name prometheus-ci -p 9090:9090 -v ${{ github.workspace }}/prometheus:/etc/prometheus --add-host=host.docker.internal:host-gateway prom/prometheus:v3.8.1 --config.file=/etc/prometheus/ci_prometheus.yml

    - name: Wait for Prometheus ready
      run: |
        for i in {1..30}; do curl --silent --fail http://localhost:9090/-/ready && exit 0 || sleep 1; done; exit 1

    - name: Start web dashboard (capture logs)
      env:
        ALLOW_UNSAFE_WERKZEUG: 'true'
      run: |
        nohup python web_dashboard.py > web_dashboard.log 2>&1 &
        sleep 2

    - name: Wait for dashboard /metrics (and print logs on failure)
      run: |
        set -e
        python .github/scripts/wait_for_metrics.py --url http://127.0.0.1:5001/metrics --retries 120 --sleep 1 --timeout 5 || (
          echo "ERROR: /metrics not responding after configured retries, dumping last 500 lines of web_dashboard.log";
          tail -n 500 web_dashboard.log || true;
          echo "--- End log dump ---";
          exit 1
        )

    - name: Ensure requests installed for checks
      run: python -m pip install requests

    - name: Debug Prometheus container and connectivity
      run: |
        echo "-- prometheus config --"
        docker exec prometheus-ci cat /etc/prometheus/ci_prometheus.yml || true
        echo "-- prometheus logs (tail 200) --"
        docker logs prometheus-ci | tail -n 200 || true
        echo "-- attempt curl to host.docker.internal:5001 from prometheus container --"
        docker exec prometheus-ci sh -c "apk add --no-cache curl >/dev/null 2>&1 || true; curl --silent --fail http://host.docker.internal:5001/metrics | head -n 50" || true

    - name: Check Prometheus sees the target
      run: |
        python .github/scripts/check_prometheus_targets.py --retries 30 --sleep 1 --timeout 5


    - name: Run integration tests
      run: |
        python -m pytest tests/integration -q

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: integration-logs
        path: |
          web_dashboard.log
          prometheus.log

    - name: Gather Prometheus logs (always)
      if: always()
      run: |
        docker logs prometheus-ci > prometheus.log || true

    - name: Stop Prometheus container
      if: always()
      run: docker rm -f prometheus-ci || true
